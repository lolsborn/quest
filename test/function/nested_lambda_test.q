# Test nested lambdas for potential stack overflow issues
use "std/test"

test.module("Nested Lambda Stack Overflow Tests")

test.describe("Basic nested lambdas", fun ()
  test.it("2-level nesting works", fun ()
    let f = fun (x) fun (y) x + y end end
    let g = f(5)
    test.assert_eq(g(3), 8)
  end)

  test.it("5-level nesting works", fun ()
    let f = fun (a) fun (b) fun (c) fun (d) fun (e)
      a + b + c + d + e
    end end end end end
    let r1 = f(1)
    let r2 = r1(2)
    let r3 = r2(3)
    let r4 = r3(4)
    let r5 = r4(5)
    test.assert_eq(r5, 15)
  end)

  test.it("10-level nesting works", fun ()
    let f = fun (a) fun (b) fun (c) fun (d) fun (e) fun (f) fun (g) fun (h) fun (i) fun (j)
      a + b + c + d + e + f + g + h + i + j
    end end end end end end end end end end
    let r1 = f(1)
    let r2 = r1(2)
    let r3 = r2(3)
    let r4 = r3(4)
    let r5 = r4(5)
    let r6 = r5(6)
    let r7 = r6(7)
    let r8 = r7(8)
    let r9 = r8(9)
    let r10 = r9(10)
    test.assert_eq(r10, 55)
  end)

  test.it("30-level nesting works", fun ()
    let f = fun (v1) fun (v2) fun (v3) fun (v4) fun (v5) fun (v6) fun (v7) fun (v8) fun (v9) fun (v10) fun (v11) fun (v12) fun (v13) fun (v14) fun (v15) fun (v16) fun (v17) fun (v18) fun (v19) fun (v20) fun (v21) fun (v22) fun (v23) fun (v24) fun (v25) fun (v26) fun (v27) fun (v28) fun (v29) fun (v30)
      v1 + v2 + v3 + v4 + v5 + v6 + v7 + v8 + v9 + v10 + v11 + v12 + v13 + v14 + v15 + v16 + v17 + v18 + v19 + v20 + v21 + v22 + v23 + v24 + v25 + v26 + v27 + v28 + v29 + v30
    end end end end end end end end end end end end end end end end end end end end end end end end end end end end end end
    
    let r1 = f(1)
    let r2 = r1(2)
    let r3 = r2(3)
    let r4 = r3(4)
    let r5 = r4(5)
    let r6 = r5(6)
    let r7 = r6(7)
    let r8 = r7(8)
    let r9 = r8(9)
    let r10 = r9(10)
    let r11 = r10(11)
    let r12 = r11(12)
    let r13 = r12(13)
    let r14 = r13(14)
    let r15 = r14(15)
    let r16 = r15(16)
    let r17 = r16(17)
    let r18 = r17(18)
    let r19 = r18(19)
    let r20 = r19(20)
    let r21 = r20(21)
    let r22 = r21(22)
    let r23 = r22(23)
    let r24 = r23(24)
    let r25 = r24(25)
    let r26 = r25(26)
    let r27 = r26(27)
    let r28 = r27(28)
    let r29 = r28(29)
    let r30 = r29(30)
    test.assert_eq(r30, 465)
  end)

  test.it("50-level nesting works", fun ()
    let f = fun (v1) fun (v2) fun (v3) fun (v4) fun (v5) fun (v6) fun (v7) fun (v8) fun (v9) fun (v10) fun (v11) fun (v12) fun (v13) fun (v14) fun (v15) fun (v16) fun (v17) fun (v18) fun (v19) fun (v20) fun (v21) fun (v22) fun (v23) fun (v24) fun (v25) fun (v26) fun (v27) fun (v28) fun (v29) fun (v30) fun (v31) fun (v32) fun (v33) fun (v34) fun (v35) fun (v36) fun (v37) fun (v38) fun (v39) fun (v40) fun (v41) fun (v42) fun (v43) fun (v44) fun (v45) fun (v46) fun (v47) fun (v48) fun (v49) fun (v50)
      v1 + v2 + v3 + v4 + v5 + v6 + v7 + v8 + v9 + v10 + v11 + v12 + v13 + v14 + v15 + v16 + v17 + v18 + v19 + v20 + v21 + v22 + v23 + v24 + v25 + v26 + v27 + v28 + v29 + v30 + v31 + v32 + v33 + v34 + v35 + v36 + v37 + v38 + v39 + v40 + v41 + v42 + v43 + v44 + v45 + v46 + v47 + v48 + v49 + v50
    end end end end end end end end end end end end end end end end end end end end end end end end end end end end end end end end end end end end end end end end end end end end end end end end end end
    
    let r1 = f(1)
    let r2 = r1(2)
    let r3 = r2(3)
    let r4 = r3(4)
    let r5 = r4(5)
    let r6 = r5(6)
    let r7 = r6(7)
    let r8 = r7(8)
    let r9 = r8(9)
    let r10 = r9(10)
    let r11 = r10(11)
    let r12 = r11(12)
    let r13 = r12(13)
    let r14 = r13(14)
    let r15 = r14(15)
    let r16 = r15(16)
    let r17 = r16(17)
    let r18 = r17(18)
    let r19 = r18(19)
    let r20 = r19(20)
    let r21 = r20(21)
    let r22 = r21(22)
    let r23 = r22(23)
    let r24 = r23(24)
    let r25 = r24(25)
    let r26 = r25(26)
    let r27 = r26(27)
    let r28 = r27(28)
    let r29 = r28(29)
    let r30 = r29(30)
    let r31 = r30(31)
    let r32 = r31(32)
    let r33 = r32(33)
    let r34 = r33(34)
    let r35 = r34(35)
    let r36 = r35(36)
    let r37 = r36(37)
    let r38 = r37(38)
    let r39 = r38(39)
    let r40 = r39(40)
    let r41 = r40(41)
    let r42 = r41(42)
    let r43 = r42(43)
    let r44 = r43(44)
    let r45 = r44(45)
    let r46 = r45(46)
    let r47 = r46(47)
    let r48 = r47(48)
    let r49 = r48(49)
    let r50 = r49(50)
    test.assert_eq(r50, 1275)
  end)
end)
