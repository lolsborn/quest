{% extends "base.html" %}

{% block title %}Admin - A Bitsetter's Blog{% endblock %}

{% block content %}
<article>
  <nav style="margin-bottom: 1rem;">
    <strong>Posts</strong> |
    <a href="/admin/pages">Pages</a> |
    <a href="/admin/media">Media</a>
  </nav>

  <header>
    <h1>Blog Administration</h1>
    <p>Manage your blog posts and pages</p>
  </header>

  <div style="margin-bottom: 1rem;">
    <a href="/admin/new" role="button" class="contrast">+ Create New Post</a>
  </div>

  <table role="grid">
    <thead>
      <tr>
        <th>Title</th>
        <th>Published</th>
        <th>Views</th>
        <th>Updated</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for post in posts %}
      <tr>
        <td>
          <a href="/post/{{ post.slug }}">{{ post.title }}</a>
          {% if not post.published %}
          <span style="color: var(--muted-color); font-size: 0.875rem;">(Draft)</span>
          {% endif %}
        </td>
        <td>{{ post.published_at_formatted }}</td>
        <td>{{ post.view_count }}</td>
        <td>{{ post.updated_at_formatted }}</td>
        <td>
          <a href="/admin/edit/{{ post.slug }}" role="button" class="secondary outline" style="margin: 0 0.25rem; padding: 0.25rem 0.5rem; font-size: 0.875rem;">Edit</a>
          <button class="delete-btn" data-slug="{{ post.slug }}" data-title="{{ post.title }}" style="margin: 0; padding: 0.25rem 0.5rem; font-size: 0.875rem;">Delete</button>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  {% if posts | length == 0 %}
  <p style="text-align: center; color: var(--muted-color); padding: 2rem;">
    No posts yet. <a href="/admin/new">Create your first post!</a>
  </p>
  {% endif %}
</article>

<style>
  table {
    width: 100%;
  }
  table a[role="button"] {
    display: inline-block;
    min-width: auto;
  }
  .delete-btn {
    background-color: var(--del-color, #c62828);
    border-color: var(--del-color, #c62828);
    color: white;
  }
  .delete-btn:hover {
    background-color: var(--del-hover-color, #b71c1c);
    border-color: var(--del-hover-color, #b71c1c);
  }
</style>

<script>
  // Handle delete buttons
  document.querySelectorAll('.delete-btn').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      const slug = e.target.dataset.slug;
      const title = e.target.dataset.title;

      if (!confirm(`Are you sure you want to delete "${title}"? This action cannot be undone.`)) {
        return;
      }

      try {
        const response = await fetch('/admin/delete/' + slug, {
          method: 'POST'
        });

        if (response.ok) {
          // Remove the row from the table
          e.target.closest('tr').remove();
        } else {
          const result = await response.json();
          alert('Failed to delete post: ' + (result.error || 'Unknown error'));
        }
      } catch (error) {
        alert('Error deleting post: ' + error.message);
      }
    });
  });
</script>
{% endblock %}
