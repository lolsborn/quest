{% extends "base.html" %}

{% block title %}Create New Post - Admin{% endblock %}

{% block content %}
<article>
  <header>
    <h1>Create New Post</h1>
  </header>

  <form id="post-form">
    <label for="title">Title</label>
    <input type="text" id="title" name="title" required>

    <label for="slug">Slug</label>
    <input type="text" id="slug" name="slug" required>

    <label for="tags">Tags (comma-separated)</label>
    <input type="text" id="tags" name="tags" placeholder="e.g. quest, tutorial, beginner">

    <label for="social_image">Social Image (OpenGraph) - Optional</label>
    <div style="display: flex; gap: 0.5rem; align-items: center;">
      <input type="text" id="social_image" name="social_image" placeholder="Select from media library" readonly>
      <button type="button" id="select-social-image-btn" class="secondary outline">Select Image</button>
      <button type="button" id="clear-social-image-btn" class="secondary outline" style="display: none;">Clear</button>
    </div>

    <label>Content</label>
    <div id="editor"></div>

    <button type="submit" class="contrast">Create Post</button>
    <a href="/admin" role="button" class="secondary outline">Cancel</a>
  </form>
</article>

<link rel="stylesheet" href="/public/toastui-editor.min.css">
<script src="/public/toastui-editor-all.min.js"></script>
<script>
  const editor = new toastui.Editor({
    el: document.querySelector('#editor'),
    height: '500px',
    initialEditType: 'markdown',
    previewStyle: 'vertical',
    initialValue: ''
  });

  // Social image selection
  const selectSocialImageBtn = document.getElementById('select-social-image-btn');
  const clearSocialImageBtn = document.getElementById('clear-social-image-btn');
  const socialImageInput = document.getElementById('social_image');

  selectSocialImageBtn.addEventListener('click', () => {
    // Simple approach: open media library in new window
    const filename = prompt('Enter the filename from the media library\n(Open /admin/media in another tab to see available files):');
    if (filename) {
      socialImageInput.value = filename;
      clearSocialImageBtn.style.display = 'inline-block';
    }
  });

  clearSocialImageBtn.addEventListener('click', () => {
    socialImageInput.value = '';
    clearSocialImageBtn.style.display = 'none';
  });

  // Auto-generate slug from title
  document.getElementById('title').addEventListener('input', (e) => {
    const slug = e.target.value
      .toLowerCase()
      .replace(/[^a-z0-9\s-]/g, '')
      .replace(/\s+/g, '-')
      .replace(/-+/g, '-')
      .trim();
    document.getElementById('slug').value = slug;
  });

  // Form submission
  document.getElementById('post-form').addEventListener('submit', async (e) => {
    e.preventDefault();

    // Parse comma-separated tags
    const tagsInput = document.getElementById('tags').value;
    const tags = tagsInput
      .split(',')
      .map(t => t.trim())
      .filter(t => t.length > 0);

    const socialImageValue = document.getElementById('social_image').value;
    const formData = {
      title: document.getElementById('title').value,
      slug: document.getElementById('slug').value,
      content: editor.getMarkdown(),
      tags: tags,
      social_image: socialImageValue || null
    };

    try {
      const response = await fetch('/admin/new', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(formData)
      });

      if (response.ok) {
        const result = await response.json();
        window.location.href = '/admin';
      } else {
        alert('Failed to create post');
      }
    } catch (error) {
      alert('Error creating post: ' + error.message);
    }
  });
</script>
{% endblock %}
