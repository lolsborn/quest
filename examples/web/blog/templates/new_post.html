{% extends "base.html" %}

{% block title %}Create New Post - Admin{% endblock %}

{% block content %}
<article>
  <header>
    <h1>Create New Post</h1>
  </header>

  <form id="post-form">
    <label for="title">Title</label>
    <input type="text" id="title" name="title" required>

    <label for="slug">Slug</label>
    <input type="text" id="slug" name="slug" required>

    <label for="tags">Tags (comma-separated)</label>
    <input type="text" id="tags" name="tags" placeholder="e.g. quest, tutorial, beginner">

    <label for="social_image">Social Image (OpenGraph) - Optional</label>
    <div style="display: flex; gap: 0.5rem; align-items: center;">
      <input type="text" id="social_image" name="social_image" placeholder="Select from media library" readonly>
      <button type="button" id="select-social-image-btn" class="secondary outline">Select Image</button>
      <button type="button" id="clear-social-image-btn" class="secondary outline" style="display: none;">Clear</button>
    </div>

    <label>Content</label>
    <div id="editor"></div>

    <button type="submit" class="contrast">Create Post</button>
    <a href="/admin" role="button" class="secondary outline">Cancel</a>
  </form>
</article>

<!-- Media Library Modal -->
<dialog id="media-modal">
  <article>
    <header>
      <button aria-label="Close" rel="prev" id="close-modal"></button>
      <h2>Select Social Image</h2>
    </header>

    <!-- Upload Section -->
    <section>
      <form id="modal-upload-form">
        <input type="file" id="modal-file-input" accept="image/png,image/jpeg,image/gif,image/webp">
        <button type="submit" class="contrast">Upload</button>
        <span id="modal-upload-status"></span>
      </form>
      <small>PNG, JPG, GIF, WebP (max 20MB)</small>
    </section>

    <hr>

    <!-- Media Grid -->
    <section id="modal-media-grid">
      <p>Loading media...</p>
    </section>

    <footer>
      <button class="secondary" id="cancel-modal">Cancel</button>
    </footer>
  </article>
</dialog>

<style>
  dialog#media-modal article {
    max-width: 900px;
    max-height: 80vh;
    overflow-y: auto;
  }

  #modal-media-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 1rem;
    max-height: 400px;
    overflow-y: auto;
  }

  .modal-media-item {
    border: 2px solid transparent;
    border-radius: 8px;
    padding: 0.5rem;
    cursor: pointer;
    transition: all 0.2s;
    background: var(--card-background-color);
  }

  .modal-media-item:hover {
    border-color: var(--primary);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }

  .modal-media-preview {
    width: 100%;
    height: 120px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--code-background-color);
    border-radius: 4px;
    overflow: hidden;
    margin-bottom: 0.5rem;
  }

  .modal-media-preview img {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
  }

  .modal-media-filename {
    font-size: 0.75rem;
    text-align: center;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  #modal-upload-form {
    display: flex;
    gap: 0.5rem;
    align-items: center;
  }

  #modal-upload-status {
    font-size: 0.875rem;
  }

  #modal-upload-status.success {
    color: var(--ins-color);
  }

  #modal-upload-status.error {
    color: var(--del-color);
  }
</style>

<link rel="stylesheet" href="/public/toastui-editor.min.css">
<script src="/public/toastui-editor-all.min.js"></script>
<script>
  const editor = new toastui.Editor({
    el: document.querySelector('#editor'),
    height: '500px',
    initialEditType: 'markdown',
    previewStyle: 'vertical',
    initialValue: ''
  });

  // Media Library Modal
  const modal = document.getElementById('media-modal');
  const closeModalBtn = document.getElementById('close-modal');
  const cancelModalBtn = document.getElementById('cancel-modal');
  const mediaGrid = document.getElementById('modal-media-grid');

  // Close modal handlers
  closeModalBtn.addEventListener('click', () => modal.close());
  cancelModalBtn.addEventListener('click', () => modal.close());

  // Load media from server
  async function loadMedia() {
    try {
      const response = await fetch('/admin/media');
      const html = await response.text();

      // Parse HTML to extract file list
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');
      const mediaItems = doc.querySelectorAll('.media-item');

      if (mediaItems.length === 0) {
        mediaGrid.innerHTML = '<p><em>No files uploaded yet</em></p>';
        return;
      }

      // Build grid HTML
      let gridHTML = '';
      mediaItems.forEach(item => {
        const filename = item.dataset.filename;
        const url = item.querySelector('.copy-url-btn').dataset.url;
        const preview = item.querySelector('.media-preview');
        const isImage = preview.querySelector('img');

        gridHTML += `
          <div class="modal-media-item" data-url="${url}" data-filename="${filename}">
            <div class="modal-media-preview">
              ${isImage ? `<img src="${url}" alt="${filename}">` : '<div class="file-icon">ðŸ“Ž</div>'}
            </div>
            <div class="modal-media-filename" title="${filename}">${filename}</div>
          </div>
        `;
      });

      mediaGrid.innerHTML = gridHTML;

      // Add click handlers to select social image
      mediaGrid.querySelectorAll('.modal-media-item').forEach(item => {
        item.addEventListener('click', () => {
          const url = item.dataset.url;
          const isImage = item.querySelector('img');

          // Only allow image selection for social images
          if (isImage) {
            socialImageInput.value = url;
            clearSocialImageBtn.style.display = 'inline-block';
            modal.close();
          }
        });
      });
    } catch (error) {
      mediaGrid.innerHTML = '<p class="error">Failed to load media</p>';
      console.error(error);
    }
  }

  // Social image selection
  const selectSocialImageBtn = document.getElementById('select-social-image-btn');
  const clearSocialImageBtn = document.getElementById('clear-social-image-btn');
  const socialImageInput = document.getElementById('social_image');

  selectSocialImageBtn.addEventListener('click', async () => {
    modal.showModal();
    await loadMedia();
  });

  clearSocialImageBtn.addEventListener('click', () => {
    socialImageInput.value = '';
    clearSocialImageBtn.style.display = 'none';
  });

  // Modal upload form
  document.getElementById('modal-upload-form').addEventListener('submit', async (e) => {
    e.preventDefault();

    const fileInput = document.getElementById('modal-file-input');
    const statusEl = document.getElementById('modal-upload-status');
    const file = fileInput.files[0];

    if (!file) {
      statusEl.textContent = 'Please select a file';
      statusEl.className = 'error';
      return;
    }

    const formData = new FormData();
    formData.append('file', file);

    statusEl.textContent = 'Uploading...';
    statusEl.className = '';

    try {
      const response = await fetch('/admin/media/upload', {
        method: 'POST',
        body: formData
      });

      const result = await response.json();

      if (response.ok && result.success) {
        statusEl.textContent = 'âœ“ Uploaded!';
        statusEl.className = 'success';

        // Clear file input
        fileInput.value = '';

        // Reload media grid
        setTimeout(() => {
          statusEl.textContent = '';
          loadMedia();
        }, 1000);
      } else {
        statusEl.textContent = 'âœ— ' + (result.error || 'Upload failed');
        statusEl.className = 'error';
      }
    } catch (error) {
      statusEl.textContent = 'âœ— ' + error.message;
      statusEl.className = 'error';
    }
  });

  // Auto-generate slug from title
  document.getElementById('title').addEventListener('input', (e) => {
    const slug = e.target.value
      .toLowerCase()
      .replace(/[^a-z0-9\s-]/g, '')
      .replace(/\s+/g, '-')
      .replace(/-+/g, '-')
      .trim();
    document.getElementById('slug').value = slug;
  });

  // Form submission
  document.getElementById('post-form').addEventListener('submit', async (e) => {
    e.preventDefault();

    // Parse comma-separated tags
    const tagsInput = document.getElementById('tags').value;
    const tags = tagsInput
      .split(',')
      .map(t => t.trim())
      .filter(t => t.length > 0);

    const socialImageValue = document.getElementById('social_image').value;
    const formData = {
      title: document.getElementById('title').value,
      slug: document.getElementById('slug').value,
      content: editor.getMarkdown(),
      tags: tags,
      social_image: socialImageValue || null
    };

    try {
      const response = await fetch('/admin/new', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(formData)
      });

      if (response.ok) {
        const result = await response.json();
        window.location.href = '/admin';
      } else {
        alert('Failed to create post');
      }
    } catch (error) {
      alert('Error creating post: ' + error.message);
    }
  });
</script>
{% endblock %}
